HE1M

medium

# Executing transaction on L2 on behalf of `OptimismPortal`

## Summary

It is possible to execute any transaction on L2 (Optimism) on behalf of `OptimismPortal` on L1.

## Vulnerability Detail

Bob (a malicious user) calls `L2ToL1MessagePasser .initiateWithdrawal` on L2 with the following parameters:
 - `_target`: Address of `OptimismPortal` on L1
 - `_gasLimit`: large enough the execute the transaction on L1 succesfully
 - `_data`: `abi.encodeWithSignature("depositTransaction(address,uint256,uint64,bool,bytes)", address of the target on L2, the value needed to be transferred to the target, required gas to execute the transaction successfully on L2, whether or not to create contract, data needed to be transferred to the target on L2)`
https://github.com/sherlock-audit/2023-03-optimism/blob/main/optimism/packages/contracts-bedrock/contracts/L2/L2ToL1MessagePasser.sol#L98-L129

When this withdrawal transaction is going to be finalized on L1 in `OptimismPortal`, it triggers the call to itself and calls the function `OptimismPortal.depositTransaction`, because the parameter `_tx.target` is equal to address of `OptimismPortal`.
https://github.com/sherlock-audit/2023-03-optimism/blob/main/optimism/packages/contracts-bedrock/contracts/L1/OptimismPortal.sol#L397

When the function `OptimismPortal.depositTransaction` is called, the `msg.sender` is equal to address of `OtimismPortal`, so the variable `from` will be set to alias of `OtimismPortal` address. 
https://github.com/sherlock-audit/2023-03-optimism/blob/main/optimism/packages/contracts-bedrock/contracts/L1/OptimismPortal.sol#L426-L465

Finally, the `TransactionDeposited` event will be emitted so that the rollup node can derive a deposit. Please note that the parameter `from` is set to alias of `OtimismPortal` address.
https://github.com/sherlock-audit/2023-03-optimism/blob/main/optimism/packages/contracts-bedrock/contracts/L1/OptimismPortal.sol#L95-L100

As a result, the receiver address on L2 will be called, or a contract will be created on L2 on behalf of `OptimismPortal` (in other words `from` will be equal to alias of `OtimismPortal` address).


## Impact
Currently, there is no clear risk. But if in the future some contracts are created on L2 relying on `OtimismPortal` as sender, a malicious user can act maliciously and execute some transaction on L2 on behalf of `OtimismPortal`.

## Code Snippet

## Tool used

Manual Review

## Recommendation
It is recommended to disallow calling unsafe targets in `OptimismPortal` to be on safe side:
```solidity
function finalizeWithdrawalTransaction(Types.WithdrawalTransaction memory _tx)
        external
        whenNotPaused
    {
        //...

        require(
            _isUnsafeTarget(_tx.target) == false,
            "OptimismPortal: cannot send message to blocked system address"
        );

        bool success = SafeCall.callWithMinGas(_tx.target, _tx.gasLimit, _tx.value, _tx.data);

        //...
    }

    function _isUnsafeTarget(address _target) internal view override returns (bool) {
        return _target == address(this);
    }
```